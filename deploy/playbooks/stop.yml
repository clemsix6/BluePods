---
# Stop all running nodes

- name: Stop all nodes
  hosts: all
  gather_facts: false
  tasks:
    - name: Find PID files
      find:
        paths: "{{ bluepods_dir }}/pids"
        patterns: "*.pid"
      register: pid_files

    - name: Read PIDs
      slurp:
        src: "{{ item.path }}"
      register: pids
      loop: "{{ pid_files.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Kill node processes
      shell: "kill {{ item.content | b64decode | trim }} 2>/dev/null || true"
      loop: "{{ pids.results }}"
      loop_control:
        label: "{{ item.item.path | basename }}"
      when: pids.results | length > 0

    - name: Wait for processes to exit
      pause:
        seconds: 3

    - name: Clean PID files
      file:
        path: "{{ bluepods_dir }}/pids"
        state: absent

    - name: Recreate PID directory
      file:
        path: "{{ bluepods_dir }}/pids"
        state: directory
